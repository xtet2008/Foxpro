易水(34691379)  2009-12-09 17:29:37

*获取网页内容
FUNCTION GETDYJ
	PARAMETERS URLNAME,XSBF,NOTXT
	DECLARE INTEGER InternetOpen IN wininet.DLL STRING, INTEGER, STRING, STRING, INTEGER
	DECLARE INTEGER InternetOpenUrl IN wininet.DLL INTEGER, STRING, STRING, INTEGER, INTEGER, INTEGER
	DECLARE INTEGER InternetReadFile IN wininet.DLL INTEGER, STRING @, INTEGER, INTEGER @
	DECLARE short InternetCloseHandle IN wininet.DLL INTEGER
	CREATE CURSOR HURL (FMEMO M)
	APPEND BLANK
	SAGENT = "DYJ4.04"
	HINTERNETSESSION = INTERNETOPEN(SAGENT,0,"","",0)
	IF HINTERNETSESSION = 0
		WAIT WINDOW "不能建立 Internet 会话期" TIMEOUT 2
		RETURN -1
	ENDIF
	HURLFILE = INTERNETOPENURL(HINTERNETSESSION,URLNAME,"",0,2147483648,0)
	IF HURLFILE

		易水(34691379)  2009-12-09 17:29:37

		= 0
		WAIT WINDOW NOWAIT "您没有连接到internet！"
		RETURN -2
	ENDIF
	URL_SIZESUM = 0
	DO WHILE .T.
		SREADBUFFER = SPACE(4096)
		LBYTESREAD = 0
		m.OK = INTERNETREADFILE(HURLFILE,@SREADBUFFER,LEN(SREADBUFFER),@LBYTESREAD)
		REPLACE HURL.FMEMO WITH SREADBUFFER ADDITIVE
		IF m.OK = 0 .OR. LBYTESREAD = 0
			EXIT
		ENDIF
		URL_SIZESUM=URL_SIZESUM+LBYTESREAD
		IF XSBF
			IF URL_SIZESUM > 0001048576
				WAIT WINDOW NOWAIT "正在接收 "+ALLTRIM(STR(URL_SIZESUM/0001048576,10,3))+"MB……"
			ELSE
				WAIT WINDOW NOWAIT "正在接收 "+ALLTRIM(STR(URL_SIZESUM/1024))+"KB……"
			ENDIF
		ENDIF
	ENDDO
	IF NOTXT
	ELSE
		LSWJM=SYS(2023)+'\M'+SYS(3)+'.TXT'
		STRTOFILE(HURL.FMEMO,LSWJM)
		CREA

		易水(34691379)  2009-12-09 17:29:37

		TE CURSOR WEBDATA (STRSQL CHANGESET (254))
		APPEND FROM (LSWJM) TYPE SDF
		ERASE (LSWJM)
	ENDIF
	= INTERNETCLOSEHANDLE(HURLFILE)
	= INTERNETCLOSEHANDLE(HINTERNETSESSION)
	WAIT  CLEAR
	RETURN URL_SIZESUM
ENDFUNC






=============================================================================


*获取网页内容
FUNCTION GET_SYTS
	PARAMETERS URLNAME
	DECLARE INTEGER InternetOpen IN wininet.DLL STRING, INTEGER, STRING, STRING, INTEGER
	DECLARE INTEGER InternetOpenUrl IN wininet.DLL INTEGER, STRING, STRING, INTEGER, INTEGER, INTEGER
	DECLARE INTEGER InternetReadFile IN wininet.DLL INTEGER, STRING @, INTEGER, INTEGER @
	DECLARE short InternetCloseHandle IN wininet.DLL INTEGER
	CREATE CURSOR HURL

	易水(34691379)  2009-12-09 17:29:37

	(FMEMOWEB M)
	APPEND BLANK
	SAGENT = "QM3D"
	HINTERNETSESSION = INTERNETOPEN(SAGENT,0,"","",0)
	IF HINTERNETSESSION = 0
		WAIT WINDOW "不能建立 Internet 会话期" TIMEOUT 2
		RETURN -999991
	ENDIF
	HURLFILE = INTERNETOPENURL(HINTERNETSESSION,URLNAME,"",0,2147483648,0)
	IF HURLFILE = 0
		WAIT WINDOW NOWAIT "您没有连接到internet！"
		RETURN -999992
	ENDIF
	URL_SIZESUM = 0
	DO WHILE .T.
		SREADBUFFER = SPACE(128)
		LBYTESREAD = 0
		m.OK = INTERNETREADFILE(HURLFILE,@SREADBUFFER,LEN(SREADBUFFER),@LBYTESREAD)
		REPLACE HURL.FMEMOWEB WITH SREADBUFFER ADDITIVE
		IF m.OK = 0 .OR. LBYTESREAD = 0
			EXIT
		ENDIF
		URL_SIZESUM=URL_SIZESUM+LBYTESREAD
	ENDDO
	= INTERNETCLOSEHANDLE(HURLFILE)
	= INTERNETCLOSEHANDLE(HINTERNETSESSIO

	易水(34691379)  2009-12-09 17:29:37

	N)
	IF "网页"$HURL.FMEMOWEB .OR. "刷新"$HURL.FMEMOWEB .OR. "Service"$HURL.FMEMOWEB
		RETURN -999993
	ELSE
		RETURN URL_SIZESUM
	ENDIF
ENDFUNC
